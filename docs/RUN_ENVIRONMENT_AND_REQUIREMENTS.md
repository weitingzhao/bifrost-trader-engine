# 运行环境与产品需求

本文档是 **Bifrost Trader Engine** 如何运行、与手动交易的关系、以及监控/控制如何设计的 **唯一正式说明**。应与产品决策保持同步，并在修改架构、部署或监控/控制功能时被贡献者和 Cursor Agent 引用。

---

## 产品需求分类（总览）

为便于与 **分步推进计划**（[PLAN_NEXT_STEPS.md](PLAN_NEXT_STEPS.md)）对齐，将需求分为 **运行环境与约束** 与 **产品功能需求** 两类；产品功能需求按领域归类，并标明实现状态与对应阶段。

### 运行环境与约束（已满足或文档约定，非待开发功能）

| 编号 | 主题 | 结论 | 说明章节 |
|------|------|------|----------|
| **RE-1** | IB / TWS 与账户 | 单一 TWS、单一账户；自动与手动通过不同 `client_id` 连接。 | §1 |
| **RE-2** | 架构 | 三支柱：自动交易（守护进程）、监控与控制（独立应用）、基于回测的策略优化与安全边界验证。 | §2 |
| **RE-3** | 部署与运行位置 | 守护程序与 TWS 同机；方案 A（Mac 单机）或 B（Linux 服务器 + 远程桌面）。 | §3 |
| **RE-4** | 监控范围 | 仅操作者本人、家庭局域网；不要求公网或手机。 | §4 |
| **RE-5** | 监控服务与交易服务分离 | **交易守护进程**必须与 IB/TWS 同机（无其他选择）；**监控服务**（独立应用）可运行在局域网内任意主机，可与交易机同机或不同机。 | §3.1 |
| **RE-6** | 交易机单进程 | 交易机仅运行 **单进程**（`run_engine.py`）：同一进程连 IB、执行对冲逻辑并轮询 DB；升级对冲逻辑需重启整个进程。 | §3.2 |
| **RE-7** | 守护程序与 IB 连接 | **不假定 IB（TWS/Gateway）已运行**。启动时若 IB 不可用，守护程序应**等待/自动重试**而非阻塞卡死；连接状态与当前 **Client ID** 须在监控端可观测；支持**监控端点击重试**或**守护程序自动重试**恢复连接，恢复后在监控端显示 Client ID。 | §3.3 |

### 产品功能需求（按领域分类）

| 领域 | 需求编号 | 需求简述 | 实现状态 | 对应分步计划阶段 | 说明章节（细节描述位置） | 验收与 Test Case（分步计划） |
|------|----------|----------|----------|------------------|--------------------------|------------------------------|
| **监控** | **R-M1** | 状态可观测：运行状态（持仓、FSM、指标、配置摘要）可不依赖控制台查看。 | 待实现 | 阶段 1（R-M1a 写出）+ 阶段 2（R-M1b 读与展示） | §4、§6 | [PLAN_NEXT_STEPS](PLAN_NEXT_STEPS.md)：R-M1a/R-M1b 验收标准 + 阶段 1/2 Test Case 清单 |
| **监控** | **R-M2** | 状态自检：可对守护程序发起自检，得到健康结论（ok/degraded/blocked）与 block_reasons。 | 待实现 | 阶段 2 | §4.1、§6 | 同上：R-M2 验收标准 + 阶段 2 Test Case 清单 |
| **监控** | **R-M3** | 红绿灯监控：监控界面须提供 **红/黄/绿** 式状态指示，通过颜色 **一目了然** 识别运行是否正常。 | 待实现 | 阶段 2 | §4、§6 | 同上：R-M3 验收标准 + 阶段 2 Test Case 清单 |
| **监控** | **R-M4** | 操作可查：能 **查询** 执行过的操作，尤其 **涉及持仓变化** 的操作（对冲下单、成交、撤单等）。 | 待实现 | 阶段 1（R-M4a 写出）+ 阶段 2（R-M4b 读与查询） | §4.2、§6 | 同上：R-M4a/R-M4b 验收标准 + 阶段 1/2 Test Case 清单 |
| **监控** | **R-M5** | 监控 Web 界面：操作者通过 **浏览器** 访问监控应用，**直观查看** 守护进程运行状态（红绿灯、自检、状态摘要、操作列表），并通过界面 **发起停止**。启动守护程序在交易机执行，不在 Web 提供。 | 待实现 | 阶段 2 | §4.3、§6 | 同上：阶段 2 验收 + Web UI 可访问、红绿灯可见、停止按钮可用 |
| **控制** | **R-C1** | 一键停止：能在局域网内 **停止** 守护程序（含优雅退出）；停止后 **不再下发任何新单**；须支持通过 **监控 Web 界面** 发起停止。启动在交易机执行 `run_engine.py`。 | 待实现 | 阶段 1（R-C1a 信号/控制文件）+ 阶段 2（R-C1b 独立应用发停止 + Web UI） | §5.1、§6 | 同上：R-C1a/R-C1b 验收标准 + 阶段 1/2 Test Case 清单 |
| **控制** | **R-C2** | 细粒度控制：**暂停/恢复** 自动对冲；暂停期间不下新单，监控与自检仍可用。 | 待实现 | 阶段 3.2（按需） | §5.2、§6 | 同上：R-C2 验收标准 + 阶段 3.2 Test Case 清单 |
| **控制** | **R-C3** | 一键平敞口（安全兜底）：红时可 **一键平掉本策略管理的对冲敞口**；仅针对本守护程序负责的对冲仓位。 | 待实现 | 阶段 2 或 3.2 | §5.1、§6 | 同上：R-C3 验收标准 + 阶段 2 或 3.2 Test Case 清单 |
| **历史与统计** | **R-H1** | 状态可扩展为带历史：写入接口支持“当前 + 历史”，避免先文件后迁库。 | 待实现 | 阶段 1 | §7、§6 | 同上：R-H1 验收标准 + 阶段 1 Test Case 清单 |
| **历史与统计** | **R-H2** | 历史统计：基于历史数据做胜率、盈亏分布、按日/周/月汇总、对冲次数与滑点等。 | 待实现 | 阶段 3.1 | §7、§6 | 同上：R-H2 验收标准 + 阶段 3.1 Test Case 清单 |
| **回测** | **R-B1** | 策略 PnL 优化：在历史数据上对比不同参数的理论 P&L、收益曲线、回撤等，优化策略回报。 | 待实现 | 阶段 3.5 | §8、§6 | 同上：R-B1 验收标准 + 阶段 3.5 Test Case 清单 |
| **回测** | **R-B2** | 安全边界验证：Guard/边界参数可验证；不同参数下对冲与拦截次数及原因可复盘。 | 待实现 | 阶段 3.5 | §8、§6 | 同上：R-B2 验收标准 + 阶段 3.5 Test Case 清单 |

**使用说明**：  
- **需求编号 ↔ 说明章节**：上表「说明章节」列指出该需求在本文档中的**细节描述位置**（如 R-M2 细节在 §4.1）；便于从分步计划中的需求编号反查到具体描述。  
  **快速对照**：R-M1、R-M3 → §4；R-M2 → §4.1；R-M4 → §4.2；R-M5 → §4.3；R-C1、R-C3 → §5.1；R-C2 → §5.2；R-H1、R-H2 → §7；R-B1、R-B2 → §8；RE-6 → §3.2；RE-7 → §3.3；§6 为小结表。  
- **验收与 Test Case**：上表「验收与 Test Case（分步计划）」列指向 [PLAN_NEXT_STEPS.md](PLAN_NEXT_STEPS.md) 中该需求的**验收标准**与**本阶段 Test Case 清单**；需求是否完成以分步计划阶段验收为准，验收须通过该阶段全部 Test Case。  
- **分步计划子项**：为明确阶段 1 与阶段 2 的验收边界，分步计划将 R-M1、R-M4、R-C1 拆为 R-M1a/1b、R-M4a/4b、R-C1a/1b；产品需求仍为 R-M1、R-M4、R-C1。新需求可按相同格式追加一行并指定阶段、说明章节与验收/Test Case 位置。

---

## 1. IB / TWS 与账户

- **数据与下单**：均通过 IB API 来自 **TWS**（Trader Workstation）。
- **账户**：**单一 IB 账户**。
- **使用方式**：该账户需同时支持：
  - **自动交易**：仅本项目的 Gamma scalping（Black–Scholes）逻辑。
  - **手动交易**：用户交易其他标的和策略，与自动交易**共享同一账户和保证金**。
- **实现方式**：TWS 允许多个 API 连接，用不同的 **client_id** 区分。守护程序使用一个 `client_id`（如 1）；手动交易使用 TWS 界面或另一个使用不同 `client_id`（如 2）的客户端。**不需要**开两个 TWS 实例。

---

## 2. 架构：三大组成部分

架构由三部分组成，缺一不可：

| 组成部分 | 说明 |
|----------|------|
| **自动交易** | 以 **单进程、单线程**（单一 asyncio 事件循环）的 **守护程序** 实现。负责连接 TWS、持仓/行情、StateClassifier、FSM、Guard、下单等；逻辑独立、可预期，守护程序内部不为交易增加额外线程或进程。 |
| **监控与控制** | 与守护程序 **物理解耦**。状态的读取、控制指令的发送由 **独立应用** 完成（例如读状态 DB/文件、提供 HTTP/CLI、写控制文件或调控制 API）。守护程序只通过最小、明确的接口暴露状态并接受指令（如状态 sink、控制文件），不内置完整 UI。 |
| **基于回测的策略优化与安全边界验证** | 使用 **历史回放** 驱动与实盘相同的 StateClassifier、FSM、Guard 逻辑，**不连 TWS、不下真实单**，产出理论 P&L、收益曲线等；**首要用于策略回报 PnL 优化**，同时用于验证与微调 Guard/边界参数（见需求文档第 8 节与分步计划阶段 3.5）。 |

- **小结**：单线程仅针对 **自动交易流程**；监控/控制由独立应用完成；回测复用自动交易核心逻辑、仅替换数据源与执行层，三者共同构成完整架构。

---

## 3. 部署：运行环境

- 守护程序 **必须与 TWS（或 IB Gateway）运行在同一台机器** 上，以便低延迟使用 TWS API，且无跨机依赖。
- 当前支持两种部署方式：

| 方案 | 说明 | 优点 | 缺点 |
|------|------|------|------|
| **A. 单机 Mac** | TWS、守护程序、手动交易均在同一台 Mac 上。 | 一台机器、部署简单、全部本地。 | Mac 休眠/电源习惯；不太适合作为 24/7 “服务器”。 |
| **B. Linux 服务器** | TWS（或 Gateway）与守护程序在一台 Linux 主机上；用户通过 **远程桌面**（RDP、VNC 等）登录该服务器进行手动交易。 | 可 24/7 运行、无休眠问题；只需维护一台“服务器”；可在局域网内任意设备远程访问。 | 需要维护 Linux 主机和远程桌面环境。 |

- **推荐**：
  - 若希望系统 **24/7 稳定运行**、尽量不碰机器（例如无头服务器 + 在局域网内其他设备远程桌面做手动交易），优先选 **B（Linux 服务器）**。
  - 若主要在同一台 Mac 上使用，手动和自动都在本机，且不需要专门的 24/7 服务器，选 **A（Mac）** 即可。
- 两种情况下都是 **一台机器** 跑 TWS + 守护程序；手动交易要么在同一台 Mac 上（A），要么通过远程桌面连到该 Linux 机器（B）。

### 3.1 监控服务与交易服务分离（RE-5）

**默认部署**：**交易机与监控机不在同一台计算机上**（跨机部署为默认需求）。即：守护进程与 TWS/IB 运行在**交易机**，status server（监控应用）运行在**监控机**，二者通过同一 PostgreSQL 通信；同机部署为可选变体。

- **交易守护进程**：因需直连 TWS/IB API，**只能与 IB（TWS 或 Gateway）运行在同一台机器**（交易机），无其他选择。
- **监控服务**（阶段 2 的独立应用，如 `run_server.py`）：与守护进程**物理解耦**，**默认运行在局域网内另一台主机**（监控机）：
  - **控制通道**：采用 **PostgreSQL 表 `daemon_control`**（见 [DATABASE.md](DATABASE.md) §2.4）。监控端 POST /control/stop 或 /control/flatten 时向该表 **INSERT** 一行；守护进程在每次 heartbeat 轮询并消费（标记 `consumed_at`）后执行。跨机与同机均只需监控与守护进程能连**同一 PostgreSQL**，无需共享文件系统（如 NFS）。
  - **跨机部署（默认）**：status server 在监控机，守护进程在交易机；状态、操作与控制均经同一数据库完成。
  - **同机部署（可选）**：status server 与守护进程均在交易机时，Stop/Flatten 仍经 DB；启动守护进程仍在交易机执行 `run_engine.py`。

**启停边界（R-C1）**：

- **停止（Stop）**：监控端 POST /control/stop → 写入 `daemon_control` → 守护进程轮询消费后退出。
- **启动（Start）**：status server 不提供启动；须在**交易机**上执行 `run_engine.py`（SSH/systemd/手动）。

### 3.2 交易机单进程（RE-6）

交易机仅运行 **单进程**（`run_engine.py`）：同一进程连接 IB、执行对冲逻辑（Daemon FSM + Hedge/Trading FSM）、轮询 `daemon_control` 与 `daemon_run_status`（stop/suspend/resume），并写心跳与状态。升级对冲逻辑需重启整个进程。

### 3.3 守护程序与 IB 连接（RE-7）：不假定 IB 已运行、运行不依赖 IB、黄灯与可观测重试

**核心原则**：**守护程序本身的运行与否不依赖 IB 是否可连接**。IB 不可用时守护程序仍保持运行，仅“启动/执行对冲”的条件不满足；监控端显示**黄灯**（降级），而非红/退出。

**问题**：若守护程序启动时 IB（TWS 或 Gateway）尚未运行或尚未就绪，实现上不得阻塞卡死或直接退出；监控端须能区分“守护进程存活但 IB 未连”与“守护进程未运行”，并显示**下次重试时间**与**自动重试**。

**需求（RE-7）**：

- **运行不依赖 IB**：守护程序**不得**因“IB 连接失败”而退出。启动时若无法连接 IB，应进入“守护进程运行中、IB 未连接”的状态（如 WAITING_IB），持续写心跳、轮询控制与挂起/恢复，并**按配置间隔周期重试**连接 IB；仅当收到显式 stop 或致命错误时才退出。
- **不预先假设 IB 已运行**：不得在实现上假定“IB 一定已启动”；首次连接与重试均采用**带超时的连接尝试**，**不得无限阻塞**。
- **未连接时监控为黄灯**：当守护进程存活但 **IB 未连接** 时，监控端自检结论为 **degraded**（黄灯），表示“守护程序在工作，但启动对冲程序的条件不满足”；**红**仅用于“守护进程未运行”或“自检 blocked”。
- **连接状态可观测**：监控端须展示**守护程序是否与 IB 保持连接**（已连接 / 未连接 / 连接中），以及连接成功时占用的 **Client ID**。
- **下次重试时间可观测**：当 IB 未连接时，守护程序将**下次计划重试时间**（如 `next_retry_ts`）写入 `daemon_heartbeat`；监控端在“守护程序”区域显示该时间，便于操作者知悉何时将自动重连。
- **自动重试**：到达下次重试时间后，守护程序**自动**发起一次连接尝试；若失败则更新 `next_retry_ts` 为下一周期并继续运行；若成功则进入正常 RUNNING、更新连接状态与 Client ID，监控端刷新即可看到。
- **监控端触发重试（可选）**：监控 Web 界面提供**「重试连接 IB」**按钮；点击后通过 `daemon_control` 写入 `retry_ib`，守护程序**立即**执行一次连接尝试，无需等到下一周期。

**实现要点（供后续开发参考）**：

- 守护程序 FSM：增加 **WAITING_IB** 状态；CONNECTING 失败时转入 WAITING_IB（而非 STOPPED）。WAITING_IB 下：写心跳（`ib_connected=false`、`next_retry_ts`）、轮询 stop/retry_ib、到点自动重试连接；成功则 CONNECTED → RUNNING，失败则更新 next_retry_ts 并保持 WAITING_IB。
- 数据与 API：`daemon_heartbeat` 表含 `ib_connected`、`ib_client_id`、**`next_retry_ts`**（timestamptz，未连接时下一计划重试时刻）；GET /status 返回上述字段；控制通道支持 `retry_ib`。
- 守护进程（run_engine.py）遵循上述行为：运行不依赖 IB，未连接时黄灯与周期重试。

---

## 4. 监控

**对应需求**：**R-M1**（状态可观测）、**R-M3**（红绿灯）、**R-M2**（§4.1 状态自检）、**R-M4**（§4.2 操作可查）。

- **目标（R-M1）**：守护程序的运行状态（如持仓、FSM 状态、指标、配置摘要）必须能 **不依赖控制台** 查看（例如不要求 `tail` 守护程序 stdout）。
- **红绿灯监控（必须，R-M3）**：监控界面须提供 **红/黄/绿** 式状态指示，使操作者能 **通过颜色一目了然** 识别当前自动交易程序运行状态是否正常：
  - **绿**：运行正常（自检结论 ok，可正常评估是否对冲）。
  - **黄**：降级（自检结论 degraded，如接近限幅、数据略旧等，需关注但非致命）。
  - **红**：异常或阻塞（自检结论 blocked，如 DATA_LAG、risk_halt、broker 异常等，当前不会发起新对冲）。
  红绿灯状态由自检结论（§4.1）驱动；独立监控应用或 UI 读取 self_check 后按上表映射为颜色展示。
- **使用者**：仅操作者本人，在 **家庭局域网** 内。
- **范围**：不要求公网或手机访问；仅局域网即可。
- **实现思路（R-M1 / R-M3）**：与第 2 节一致：例如守护程序将状态写入 **状态文件** 或 **数据库**（Redis / PostgreSQL）；由 **独立** 的监控应用（或简单 HTTP 界面）读取并展示，**且须包含红绿灯状态**。守护程序本身可只提供最小只读接口，或仅“把状态写到某处”，不提供完整 UI。

### 4.1 状态自检（R-M2，供监控控制台使用）

**需求编号：R-M2**

- **目标**：操作者或监控控制台能够对守护程序发起 **状态自检**，得到“当前状态是否正常、各状态与参数是否符合期望”的结论，而不仅限于查看原始状态数据。
- **意义**（对自动交易程序）：
  - **运行信心**：在无人值守前或定期确认“守护程序自检通过”，即 FSM、数据新鲜度、Guard 条件、配置等均在预期内。
  - **排障**：当长时间未对冲或行为异常时，自检可快速给出 **阻塞原因**（如 DATA_LAG、PAUSE_COST、risk_halt），与“当前状态是什么”形成互补。
  - **自动化监控**：监控应用可定期拉取自检结果，在结果为非 OK 或出现指定条件时告警。
- **形态**：自检由守护进程执行（复用现有 CompositeState、guards、config），结果为只读；可通过 sink 写入（如每次 heartbeat 写入最近一次自检结果），或由控制通道触发“执行一次自检并写回 sink”。监控控制台从 sink 读取并展示（或提供“触发自检”按钮后刷新）。自检输出建议包含：总体结论（**ok / degraded / blocked**，用于驱动 **红绿灯**：ok→绿、degraded→黄、blocked→红）、各项检查（如 data_fresh、greeks_ok、risk_halt、in_trading_hours）、以及若不可对冲时的 block_reasons。
- **与现有设计关系**：不改变交易逻辑；仅基于当前状态与配置做一次只读评估并输出结论，属监控/控制范畴，可在阶段 2 与独立监控应用一并考虑（例如 snapshot 中增加 self_check 字段，或独立应用触发后读 sink 中的自检结果）。

### 4.2 操作可查（R-M4：执行记录查询）

- **目标（R-M4）**：操作者能够 **查询** 自动交易程序 **已执行的操作**，尤其是 **导致持仓变化的操作**（如对冲下单、成交、部分成交、撤单等），用于审计、排障与复盘。
- **范围**：至少覆盖与持仓相关的动作——例如：对冲意图产生、订单发送、订单成交（含数量与价格）、订单取消/拒绝等；每条记录建议包含时间、类型、方向（BUY/SELL）、数量、价格（若已成交）、以及当时触发的状态或原因（如 D2/D3、block_reason 等，便于回溯）。
- **实现思路（R-M4a/R-M4b）**：守护程序在执行上述操作时，将 **操作/事件记录** 写入与状态相同的 sink（如 SQLite 的“操作表”或事件流）；独立监控应用提供 **查询接口**（如 `GET /operations?since=...&limit=...` 或按时间范围、类型筛选），并在界面或 CLI 中展示列表与详情。可与阶段 1 的“当前 + 历史”设计统一：操作记录即一类历史事件。

### 4.3 监控 Web 界面（R-M5）

**需求编号：R-M5**

- **目标**：操作者通过 **浏览器** 打开监控应用提供的 Web 页面，**直观看到** 自动交易守护程序的运行状态，无需依赖 curl 或命令行。界面须包含：
  - **红绿灯**（R-M3）：当前状态一目了然（绿/黄/红）；
  - **自检结论**（R-M2）：ok / degraded / blocked 及 block_reasons；
  - **守护程序区**：须包含 **与 IB 连接状态**（已连接 / 未连接 / 连接中）及连接成功时的 **Client ID**（RE-7）；若断开，可点击「重试连接 IB」或依赖守护程序自动重试，恢复后在界面显示 Client ID；
  - **状态摘要**：daemon_state、trading_state、标的、持仓、当日对冲次数等（来自 GET /status）；
  - **操作列表**（R-M4）：近期涉及持仓变化的操作，可刷新或自动更新；
  - **控制**（R-C1）：**停止**、**一键平敞口** 按钮（POST /control/stop、POST /control/flatten）；**重试连接 IB**（POST /control/retry_ib 或等效，RE-7）。启动守护程序在交易机执行，不在 Web 界面提供。
- **范围**：局域网内浏览器访问，与 RE-4 一致；不要求公网或手机 App。
- **实现形态**：独立监控应用（status server）提供 GET / 单页 Web 界面，调用 GET /status、GET /operations、POST /control/stop、POST /control/flatten。

---

## 5. 控制（与监控配套的安全能力）

- **定位**：自动交易程序与 **核反应堆** 类似——**监控** 负责“看清运行状态、红黄绿一目了然”，**控制** 负责“在需要时能立即干预，确保不出现运行风险”。控制能力与监控红绿灯配套：见 **绿** 可放心运行；见 **黄** 可关注或暂停新对冲；见 **红** 必须能 **一键停止**，必要时 **一键平敞口**。
- **目标**：操作者能在局域网内通过 **独立应用** 对守护程序发出控制指令，无需登录控制台；控制由独立应用发出（写控制文件或调控制 API），守护程序只负责轮询或接收并执行。

### 5.1 必须的控制能力（R-C1、R-C3，安全兜底）

| 能力 | 需求编号 | 说明 | 与监控的对应 |
|------|----------|------|--------------|
| **一键停止** | **R-C1** | 启动与停止守护程序（优雅退出）。停止后守护程序 **不再下发任何新单**，进程退出。 | **红/黄/绿** 任一状态下均可使用；**红** 时必须能立即执行，避免继续运行异常逻辑。 |
| **一键平敞口** | **R-C3** | 在 **红** 或操作者判断需紧急降敞口时，**一键平掉本策略管理的对冲敞口**（即自动对冲所用的股票持仓平至目标，如 0 或与当前期权 delta 匹配）。**仅针对本守护程序负责的对冲仓位**，不触碰账户内其他头寸（如手动交易、其他策略）。 | 与 **红** 灯配套：不仅“停新单”，还能主动 **卸掉已有敞口**，实现“反应堆停堆+卸料”级安全。 |

- **实现思路**：R-C1 已规划（信号 + 控制文件/API；独立应用 POST /control/stop）。R-C3 可通过控制通道下发 `flatten`（或等效）指令；守护进程收到后先停止接受新的对冲逻辑，再根据当前持仓与配置下发平仓单（目标持仓 0 或与期权 delta 一致），并将该次操作写入操作记录（R-M4）；可选：平敞口完成后自动进入 stop 或保持待命。具体接口形态（控制文件键值或 API 路径）与阶段 2 独立应用一并设计。

### 5.2 后续/可选的控制能力（R-C2）

| 能力 | 需求编号 | 说明 |
|------|----------|------|
| **暂停/恢复** | **R-C2** | 暂停期间 **不再下发新的对冲单**，但守护进程保持运行，监控与自检仍可用；恢复后继续正常对冲。适用于 **黄** 灯时“先暂停新单、观察再决定是否停止或平敞口”。 |

- 控制由 **独立应用** 发出指令（例如写入控制文件、FIFO 或小型控制 API），守护程序只负责感知并执行；守护程序内部不必运行完整的“控制服务”。

---

## 6. 小结表（便于快速查阅）

| 主题 | 结论 | 需求编号 |
|------|------|----------|
| IB / 账户 | 单一 TWS、单一账户；自动与手动通过不同 `client_id` 连接。 | RE-1 |
| 守护程序 | 单进程、单线程（一个 asyncio 循环）；仅承载自动交易逻辑。 | RE-2 |
| 监控与控制 | 由独立应用实现；与守护程序物理解耦。 | RE-2 |
| 守护程序运行位置 | 与 TWS 同机（Mac 或 Linux）。 | RE-3 |
| 部署选择 | 24/7 + 远程桌面优先选 Linux 服务器（B）；单机桌面场景可选 Mac（A）。 | RE-3 |
| 监控使用者 | 仅操作者本人，家庭局域网。 | RE-4 |
| 监控与交易分离 | 交易守护进程必须与 IB 同机；监控服务可运行在局域网内任意主机（同机或不同机）；不同机时控制需共享存储（如 NFS）或后续 DB 通道。 | RE-5 |
| 交易机单进程 | 仅 run_engine.py 单进程：同进程连 IB + 对冲逻辑 + 轮询控制；升级需重启整个进程。 | RE-6 |
| 守护程序与 IB 连接 | 不假定 IB 已运行；启动时若 IB 不可用则等待/自动重试而非卡死；监控端展示连接状态与 Client ID；支持监控端重试或守护程序自动重试，恢复后显示 Client ID。 | RE-7 |
| 状态可观测 | 运行状态可不依赖控制台查看（经 sink → 独立应用）。 | R-M1 |
| 状态自检 | 守护程序支持状态自检，供监控控制台调用；结论（ok/degraded/blocked）+ block_reasons（见 §4.1）。 | R-M2 |
| 红绿灯监控 | 监控界面须提供红/黄/绿状态指示，通过颜色一目了然识别运行是否正常（绿=ok，黄=degraded，红=blocked）。 | R-M3 |
| 操作可查 | 能查询自动交易程序执行过的操作，尤其涉及持仓变化的操作（对冲下单、成交、撤单等）；供审计与排障。 | R-M4 |
| 监控 Web 界面 | 浏览器打开监控页，直观查看红绿灯、自检、状态、操作列表，并通过界面发起停止。启动在交易机执行。 | R-M5 |
| 一键停止 | 停止守护程序（含优雅退出）；停止后不再下发任何新单；须支持通过 Web 界面操作。启动守护程序在交易机执行 run_engine.py；见 §3.1。 | R-C1 |
| 一键平敞口 | 异常/红时可一键平掉本策略管理的对冲敞口（仅对冲仓位，不碰其他头寸）。 | R-C3 |
| 控制后续 | 暂停/恢复自动对冲（细粒度控制）。 | R-C2 |
| 状态可扩展为带历史 | sink 设计支持当前 + 历史，避免先文件后迁库。 | R-H1 |
| 历史数据与统计 | 已规划待实现；独立读历史 DB 做聚合，不跑 FSM/Guard。 | R-H2 |
| 回测（策略 PnL 优化 + Guard 验证） | 已规划待实现；首要策略 PnL 优化，兼做安全边界验证；复用 FSM/Guard，历史回放，不真实下单。 | R-B1, R-B2 |

**与分步计划对照**：需求分类表（见本文档开头的「产品需求分类」）中已列出各产品需求与阶段的对应关系；分步计划按阶段交付上表需求。

---

## 7. 待实现需求：历史数据与统计（R-H1、R-H2）

**需求编号**：**R-H1**（状态可扩展为带历史）、**R-H2**（历史统计）。

- **定位**：与监控、控制、回测一样，属于 **当前已规划、待实现** 的产品需求；“后续”仅指在分步推进计划中排在后期阶段实现，而非“可选或远期再说”。
- **目标**：本软件需要基于 **历史数据** 的总结与统计功能，例如：
  - 交易胜率、盈亏分布、按日/周/月汇总；
  - 对冲次数、滑点与延迟的统计；
  - 状态与风控触发的历史回放或审计。
- **含义**：
  - 守护程序暴露的“状态”不应只满足“当前视图”，而应在一开始就考虑 **可扩展为带历史的存储**（例如同一套写入接口既可写“当前状态”也可写“历史快照/事件”），避免先做纯状态文件、再整体迁库导致大重构。
  - 存储形态：可选用状态文件（仅当前）或从阶段 1 就支持 SQLite/Redis/PostgreSQL 等带历史能力的后端；具体选型与 **历史统计逻辑如何落地、与自动交易代码的关系** 见分步计划文档。
- **小结**：历史数据与统计是已确定的待实现需求；状态暴露与持久化方案在分步计划中与监控一起设计；历史统计的代码落地方式也在分步计划中规划。

---

## 8. 待实现需求：回测（R-B1、R-B2：策略 PnL 优化与安全边界验证）

**需求编号**：**R-B1**（策略 PnL 优化）、**R-B2**（安全边界验证）。

- **定位**：同上，**已规划、待实现**；“后续”仅指在分步计划中的实现阶段靠后（依赖历史数据），而非“可选”。
- **需求**：
  - **策略回报 PnL 优化**（主要）：在历史数据上对比不同参数组合下的 **理论 P&L、夏普/回撤、对冲频率与滑点** 等，用于 **优化策略收益**，而不只依赖实盘试错。
  - **安全边界验证**：Guard 与边界参数（cooldown、threshold_hedge_shares、价差/熔断等）的 **有效性与合理性** 可验证；不同参数下对冲次数、被各 guard 拦截的次数（及原因）便于“该冲未冲 / 不该冲却冲”的复盘与微调。
- **回测作为手段**：在 **不连接 TWS 实盘** 的前提下，用 **历史行情与持仓快照** 回放，驱动与实盘 **同一套** 状态分类、TradingFSM、ExecutionGuard 逻辑，得到：
  - 在不同参数组合下：**理论 P&L、收益曲线、最大回撤**；对冲次数、被各 guard 拦截的次数（及原因）、最大敞口等；
  - 便于 **策略参数优化**（如 threshold、cooldown、价差门控）与 **安全边界微调**。
- **与自动交易逻辑的关系**：回测 **复用** 自动交易中的 StateClassifier、TradingFSM、ExecutionGuard、gamma_scalper_intent、apply_hedge_gates 等核心逻辑，仅 **数据来源** 改为历史回放、**执行** 改为模拟（不真实下单）。具体代码如何抽离/复用、放在哪一阶段实现，见分步计划。
- **小结**：回测是已确定的待实现需求，**首要用于策略 PnL 优化**，同时支持 Guard/安全边界验证；实现上依赖历史存储，并在分步计划中明确与自动交易逻辑的复用与落地方式。

---

*最后更新：新增 RE-7 与 §3.3 守护程序与 IB 连接（不假定 IB 已运行、可观测连接状态与 Client ID、支持重试）；§4.3 R-M5 与 §5 控制补充“重试连接 IB”与监控展示要求；ARCHITECTURE §5.1 同步 RE-7。*
