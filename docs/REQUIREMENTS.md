# 产品需求

本文档是 **Bifrost Trader Engine** 的**产品功能需求**唯一定义。需求不随运行环境变化；**运行环境与部署约束**见 [ARCHITECTURE.md](ARCHITECTURE.md) 的「运行环境与部署约束」（§2）。

与 [PLAN_NEXT_STEPS.md](PLAN_NEXT_STEPS.md) 对齐：各需求按阶段交付，验收标准与 Test Case 以分步计划为准。

---

## 产品需求分类（总览）

产品需求按以下五类组织：

| 分类 | 需求编号 | 需求简述 | 实现状态 | 对应阶段 | 说明章节 | 验收与 Test Case |
|------|----------|----------|----------|----------|----------|-------------------|
| **a. 守护程序相关** | **R-H1** | 状态可扩展为带历史：写入接口支持“当前 + 历史”，避免先文件后迁库。 | 待实现 | 阶段 1 | §1.1 | PLAN_NEXT_STEPS 阶段 1 |
| | **R-C1** | 一键停止：能在局域网内停止守护程序（含优雅退出）；停止后不再下发任何新单；须支持通过监控 Web 界面发起停止。 | 待实现 | 阶段 1（R-C1a）+ 阶段 2（R-C1b） | §1.2 | 同上 R-C1a/1b |
| | **R-C2** | 暂停/恢复自动对冲；暂停期间不下新单，监控与自检仍可用。 | 待实现 | 阶段 5 | §1.3 | 阶段 5 Test Case |
| **b. 监控相关** | **R-M1** | 状态可观测：运行状态（持仓、FSM、指标、配置摘要）可不依赖控制台查看。 | 待实现 | 阶段 1（写出）+ 阶段 2（读与展示） | §2.1 | R-M1a/1b |
| | **R-M2** | 状态自检：可对守护程序发起自检，得到健康结论（ok/degraded/blocked）与 block_reasons。 | 待实现 | 阶段 2 | §2.2 | 阶段 2 |
| | **R-M3** | 红绿灯监控：监控界面须提供红/黄/绿式状态指示，一目了然识别运行是否正常。 | 待实现 | 阶段 2 | §2.1 | 阶段 2 |
| | **R-M4** | 操作可查：能查询执行过的操作，尤其涉及持仓变化的操作（对冲下单、成交、撤单等）。 | 待实现 | 阶段 1（写出）+ 阶段 2（查询） | §2.3 | R-M4a/4b |
| | **R-M5** | 监控 Web 界面：操作者通过浏览器访问监控应用，直观查看守护进程运行状态（红绿灯、自检、状态摘要、操作列表），并通过界面发起停止等控制。 | 待实现 | 阶段 2 | §2.4 | 阶段 2 |
| **c. 金融数据采集** | **R-A1** | 账户与持仓可获取：从 IB 获取当前账户基本信息与当前持仓，作为自动交易对冲的基本能力。 | 待实现 | 阶段 3 | §3.1 | 阶段 3 |
| | **R-M6** | 标的与持仓当前市价可获取：监控页须能获取并展示交易标的与持仓的当前市价（spot/last/mid 等），供评估持仓盈亏、期权虚实与风险。 | 待实现 | 阶段 3 | §3.2 | 阶段 3 |
| **d. 策略编辑、回测与历史统计** | **R-H2** | 历史统计：基于历史数据做胜率、盈亏分布、按日/周/月汇总、对冲次数与滑点等。 | 待实现 | 阶段 3 | §4.1 | 阶段 3 |
| | **R-B1** | 策略 PnL 优化：在历史数据上对比不同参数的理论 P&L、收益曲线、回撤等，优化策略回报。 | 待实现 | 阶段 4 | §4.2 | 阶段 4 |
| | **R-B2** | 安全边界验证：Guard/边界参数可验证；不同参数下对冲与拦截次数及原因可复盘。 | 待实现 | 阶段 4 | §4.2 | 阶段 4 |
| **e. 策略应用（自动交易）** | **R-C3** | 一键平敞口：异常或红时可一键平掉本策略管理的对冲敞口；仅针对本守护程序负责的对冲仓位。依赖 R-A1 及策略边界等。 | 待实现 | 阶段 5 | §5 | 阶段 5（Test Case 待补全） |

**说明**：  
- 「说明章节」列指向本文档中该需求的细节描述位置。  
- 验收与 Test Case 以 [PLAN_NEXT_STEPS.md](PLAN_NEXT_STEPS.md) 各阶段验证标准与 Test Case 清单为准。

---

## 1. 守护程序相关（a）

### 1.1 状态可扩展为带历史（R-H1）

- **目标**：sink 写入接口支持“当前视图 + 历史表”，避免先文件后迁库；后续增加历史查询或统计时无需修改守护程序写逻辑。
- **范围**：sink 表结构或写入接口同时支持当前视图（单行或最新 ts）与历史表（append 或按间隔采样）；配置可选择 sink 类型与路径，守护程序按配置写入。

### 1.2 一键停止（R-C1）

- **目标**：能在局域网内**停止**守护程序（含优雅退出）；停止后**不再下发任何新单**；须支持通过**监控 Web 界面**发起停止。
- **范围**：R-C1a 信号/控制文件（阶段 1）；R-C1b 独立应用发停止 + Web UI（阶段 2）。启动守护程序在交易机执行 `run_engine.py`，不在 Web 提供。

### 1.3 暂停/恢复（R-C2）

- **目标**：细粒度控制——**暂停**期间不再下发新的对冲单，但守护进程保持运行，监控与自检仍可用；**恢复**后继续正常对冲。适用于黄灯时“先暂停新单、观察再决定是否停止或平敞口”。

---

## 2. 监控相关（b）

### 2.1 状态可观测与红绿灯（R-M1、R-M3）

- **目标（R-M1）**：守护程序的运行状态（持仓、FSM 状态、指标、配置摘要）必须能**不依赖控制台**查看（经 sink → 独立应用）。
- **红绿灯（R-M3，必须）**：监控界面须提供**红/黄/绿**式状态指示：
  - **绿**：运行正常（自检结论 ok）。
  - **黄**：降级（degraded，需关注但非致命）。
  - **红**：异常或阻塞（blocked，当前不会发起新对冲）。
- **使用者与范围**：仅操作者本人，**局域网**内；不要求公网或手机访问。

### 2.2 状态自检（R-M2）

- **目标**：操作者或监控控制台能够对守护程序发起**状态自检**，得到“当前状态是否正常、各状态与参数是否符合期望”的结论。
- **形态**：自检由守护进程执行（复用现有 CompositeState、guards、config），结果为只读；可通过 sink 写入。自检输出包含：总体结论（**ok / degraded / blocked**，驱动红绿灯）、各项检查、以及若不可对冲时的 block_reasons。

### 2.3 操作可查（R-M4）

- **目标**：操作者能够**查询**自动交易程序**已执行的操作**，尤其是**导致持仓变化的操作**（如对冲下单、成交、撤单等），用于审计、排障与复盘。
- **范围**：至少覆盖与持仓相关的动作；每条记录建议包含时间、类型、方向、数量、价格（若已成交）、以及当时触发的状态或原因（如 D2/D3、block_reason 等）。守护程序将操作/事件记录写入 sink；独立监控应用提供查询接口（如 `GET /operations`）。

### 2.4 监控 Web 界面（R-M5）

- **目标**：操作者通过**浏览器**打开监控应用提供的 Web 页面，**直观看到**守护程序的运行状态。界面须包含：红绿灯（R-M3）、自检结论（R-M2）、与 IB 连接状态及 Client ID、状态摘要、操作列表（R-M4）、控制（停止、一键平敞口、重试连接 IB 等）。启动守护程序在交易机执行，不在 Web 提供。
- **范围**：局域网内浏览器访问；不要求公网或手机 App。

---

## 3. 金融数据采集（c）

### 3.1 账户与持仓可获取（R-A1）

- **目标**：自动交易程序能够从 IB **获取当前账户基本信息**（如账户 ID、Balance、NetLiquidation 等）以及**当前持仓**（股票、期权等），作为自动交易对冲的**基本前置能力**。
- **范围**：账户信息至少含账户标识、现金/权益类汇总；当前持仓至少含本策略可能涉及的标的的持仓数量与方向。数据在运行周期内可持续更新，异常或断连时行为明确（重试或降级）。
- **与分步计划**：阶段 3（数据获取）。

### 3.2 标的与持仓当前市价可获取（R-M6）

- **目标**：监控页须能获取并展示**交易标的**与**持仓**的**当前市价**（如标的 spot、bid/ask 或 last/mid），供评估持仓盈亏、期权虚实与风险；对自动交易程序为必备能力。
- **范围**：至少包含本策略涉及的**标的 spot**（或等价 last/mid），在 GET /status 或 sink 当前视图中可供监控页读取；多标的/多腿时各标的当前价须可区分获取。数据由守护程序在运行中从 IB 拉取并写入 sink/status。
- **与分步计划**：阶段 3（数据获取）。

---

## 4. 策略编辑、回测与历史统计（d）

### 4.1 历史统计（R-H2）

- **目标**：基于历史数据做胜率、盈亏分布、按日/周/月汇总、对冲次数与滑点等。
- **形态**：存在**独立脚本或模块**（如 `scripts/stats_from_history.py` 或 `src/stats/`），**只读**阶段 1 sink 写入的历史表；**不跑** FSM/Guard/StateClassifier。输出至少包含按日/周对冲次数、盈亏分布或汇总；可离线运行，不依赖守护进程在线。
- **与分步计划**：阶段 3。

### 4.2 回测（R-B1、R-B2）

- **R-B1（策略 PnL 优化）**：在历史数据上对比不同参数组合下的理论 P&L、夏普/回撤、对冲频率与滑点等，用于**优化策略收益**。
- **R-B2（安全边界验证）**：Guard 与边界参数的有效性与合理性可验证；不同参数下对冲次数、被各 guard 拦截的次数及原因便于复盘与微调。
- **回测作为手段**：**不连接 TWS 实盘**，用**历史行情与持仓快照**回放，驱动与实盘**同一套** StateClassifier、TradingFSM、ExecutionGuard 逻辑；产出理论 P&L、收益曲线、最大回撤及决策与 block reason。实现依赖历史存储，见 [PLAN_NEXT_STEPS.md](PLAN_NEXT_STEPS.md) 阶段 4。
- **策略编辑**：当前阶段以配置（YAML/gates）与回测参数对比为主；若后续支持可视化策略编辑或策略模板，可在本类下扩展需求。

---

## 5. 策略应用（自动交易）（e）

### 5.1 一键平敞口（R-C3）

- **目标**：在**红**或操作者判断需紧急降敞口时，**一键平掉本策略管理的对冲敞口**（即自动对冲所用的股票持仓平至目标，如 0 或与当前期权 delta 匹配）。**仅针对本守护程序负责的对冲仓位**，不触碰账户内其他头寸（如手动交易、其他策略）。
- **与监控的对应**：与**红**灯配套——不仅“停新单”，还能主动**卸掉已有敞口**，实现安全兜底。
- **实现依赖**：R-A1（账户与持仓可获取）、策略边界与平仓逻辑等；安排在阶段 5。控制通道支持 `flatten`；守护进程收到后根据当前账户/持仓与目标计算平仓量并下单，将此次操作写入 sink 操作记录；独立应用提供 POST /control/flatten。

---

## 6. 小结表（便于快速查阅）

| 分类 | 需求编号 | 主题 |
|------|----------|------|
| a. 守护程序相关 | R-H1 | 状态可扩展为带历史 |
| | R-C1 | 一键停止 |
| | R-C2 | 暂停/恢复 |
| b. 监控相关 | R-M1 | 状态可观测 |
| | R-M2 | 状态自检 |
| | R-M3 | 红绿灯监控 |
| | R-M4 | 操作可查 |
| | R-M5 | 监控 Web 界面 |
| c. 金融数据采集 | R-A1 | 账户与持仓可获取 |
| | R-M6 | 标的与持仓当前市价可获取 |
| d. 策略编辑、回测与历史统计 | R-H2 | 历史统计 |
| | R-B1、R-B2 | 回测（策略 PnL 优化 + Guard 验证） |
| e. 策略应用（自动交易） | R-C3 | 一键平敞口 |

**运行环境与约束**（如 IB/账户、部署、监控与交易分离、单进程、守护程序与 IB 连接等）见 [ARCHITECTURE.md](ARCHITECTURE.md)「运行环境与部署约束」（§2）。

---

*最后更新：2026-02-26，删除运行环境与需求索引文件；产品需求按五类（守护程序、监控、金融数据采集、策略编辑/回测/历史统计、策略应用）重新规划。*
